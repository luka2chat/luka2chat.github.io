---
import type { InferGetStaticPropsType, GetStaticPaths } from 'astro';

import merge from 'lodash.merge';
import type { ImageMetadata } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import ToBlogLink from '~/components/blog/ToBlogLink.astro';

import { getCanonical, getPermalink } from '~/utils/permalinks';
import { fetchPosts } from '~/utils/blog';
import { findImage } from '~/utils/images';
import type { MetaData } from '~/types';
import RelatedPosts from '~/components/blog/RelatedPosts.astro';

export const prerender = true;

export const getStaticPaths = (async () => {
  const posts = await fetchPosts();
  
  return posts.flatMap((post) => ({
    params: {
      slug: post.slug,
    },
    props: { post },
  }));
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.props as Props;

const url = getCanonical(`/zh/blog/${post.slug}`);
const image = (await findImage(post.image)) as ImageMetadata | string | undefined;

const metadata = merge(
  {
    title: post.title,
    description: post.excerpt,
    robots: {
      index: true,
      follow: true,
    },
    openGraph: {
      type: 'article',
      ...(image
        ? { images: [{ url: image, width: (image as ImageMetadata)?.width, height: (image as ImageMetadata)?.height }] }
        : {}),
    },
  },
  { ...(post?.metadata ? { ...post.metadata, canonical: post.metadata?.canonical || url } : {}) }
) as MetaData;
---

<Layout metadata={metadata}>
  <SinglePost post={{ ...post, image: image }} url={url}>
    {post.Content ? <post.Content /> : <Fragment set:html={post.content || ''} />}
  </SinglePost>
  <div class="mx-auto px-6 sm:px-6 max-w-3xl pt-8 md:pt-16">
    <a
      class="btn text-muted dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700 text-sm"
      href="/zh/blog"
    >
      <svg
        class="w-5 h-5 mr-1 -ml-1 rtl:mr-0 rtl:ml-1"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 20 20"
        fill="currentColor"
        aria-hidden="true"
      >
        <path
          fill-rule="evenodd"
          d="M7.707 14.707a1 1 0 01-1.414 0L2.586 11H14a1 1 0 110 2H2.586l3.707 3.293a1 1 0 01-1.414 1.414l-5.293-5.293a1 1 0 010-1.414L4.293 6.707a1 1 0 011.414 1.414L2.586 11H14a1 1 0 110 2H2.586l3.707 3.293z"
          clip-rule="evenodd"></path>
      </svg>
      返回博客
    </a>
  </div>
  <RelatedPosts post={post} />
</Layout>